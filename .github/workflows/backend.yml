name: Backend

on:
  workflow_call:
    inputs:
      environment:
        type: string
        description: environment to deploy to
        required: true
        
jobs:
  build:
    name: Build and Smoke Test
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    permissions:
      id-token: write
      contents: read
    outputs:
      shaShort: ${{ steps.revParse.outputs.shaShort }}
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Get Commit SHA
        id: revParse
        run: echo "shaShort=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      
      - name: Docker - Build
        run: docker buildx build --platform linux/amd64 --tag ${{ secrets.ECR_REPO_URL }}:${{ steps.revParse.outputs.shaShort }} --load ./backend 

      - name: Snyk - Test Image
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: "${{ secrets.ECR_REPO_URL }}:${{ steps.revParse.outputs.shaShort }}"
          args: --severity-threshold=high --file=./backend/Dockerfile --policy-path=./backend/.snyk
      
      - name: Start API and Postgres Containers
        uses: hoverkraft-tech/compose-action@v2.0.2
        with:
          compose-file: ./backend/actions-compose.yml
        env:
          API_IMAGE_URI: "${{ secrets.ECR_REPO_URL }}:${{ steps.revParse.outputs.shaShort }}"
          
          # for postgre container
          POSTGRES_DB: ztmf
          POSTGRES_USER: admin
          POSTGRES_PASSWORD: localDev

          # for api container and debug launch config
          PORT: 8080
          DB_ENDPOINT: localhost
          DB_PORT: 5432
          DB_NAME: ztmf
          DB_USER: admin
          DB_PASS: localDev 
          DB_POPULATE: "/src/backend/_test_data_empire.sql"
          AUTH_HS256_SECRET: "zeroTrust"
          AUTH_HEADER_FIELD: "Authorization"
          WORKSPACE: ${{ github.workspace }}

      - name: Emberfall Smoke Tests
        uses: aquia-inc/emberfall@main
        with:
          version: 0.3.1
          file: ./backend/emberfall_tests.yml

      - name: AWS - Get Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.ROLEARN }}
          role-duration-seconds: 900
          aws-region: us-east-1
              
      - name: Docker - Login
        run: aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin ${{ secrets.ECR_REPO_URL }}
  
      - name: Docker - Push
        run: docker push ${{ secrets.ECR_REPO_URL }}:${{ steps.revParse.outputs.shaShort }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.1'

      - name: Lambda - Build (Data Sync)
        run: |
          set -e
          cd backend
          echo "Building Data Sync Lambda..."
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -ldflags '-extldflags "-static"' -o bootstrap ./cmd/lambda/.
          zip lambda-deployment-${{ steps.revParse.outputs.shaShort }}.zip bootstrap
          rm bootstrap
          ls -la lambda-deployment-${{ steps.revParse.outputs.shaShort }}.zip

      - name: Lambda - Build (CFACTS Snowflake)
        run: |
          set -e
          cd backend
          echo "Building CFACTS Snowflake Sync Lambda..."
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -ldflags '-extldflags "-static"' -o bootstrap ./cmd/lambda-cfacts-snowflake/.
          zip cfacts-snowflake-deployment-${{ steps.revParse.outputs.shaShort }}.zip bootstrap
          rm bootstrap
          ls -la cfacts-snowflake-deployment-${{ steps.revParse.outputs.shaShort }}.zip

      - name: Lambda - Build (CFACTS S3)
        run: |
          set -e
          cd backend
          echo "Building CFACTS S3 CSV Sync Lambda..."
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -ldflags '-extldflags "-static"' -o bootstrap ./cmd/lambda-cfacts-s3/.
          zip cfacts-s3-deployment-${{ steps.revParse.outputs.shaShort }}.zip bootstrap
          rm bootstrap
          ls -la cfacts-s3-deployment-${{ steps.revParse.outputs.shaShort }}.zip

      - name: Lambda - Upload to S3
        run: |
          set -e
          ENV_LOWER=$(echo "${{ inputs.environment }}" | tr '[:upper:]' '[:lower:]')
          LAMBDA_BUCKET="ztmf-lambda-deployments-${ENV_LOWER}"
          SHA="${{ steps.revParse.outputs.shaShort }}"
          echo "Uploading Lambda packages to bucket: $LAMBDA_BUCKET"

          # Data Sync Lambda
          aws s3 cp backend/lambda-deployment-${SHA}.zip s3://$LAMBDA_BUCKET/lambda-deployment-${SHA}.zip
          aws s3 cp backend/lambda-deployment-${SHA}.zip s3://$LAMBDA_BUCKET/lambda-deployment-latest.zip

          # CFACTS Snowflake Lambda
          aws s3 cp backend/cfacts-snowflake-deployment-${SHA}.zip s3://$LAMBDA_BUCKET/cfacts-snowflake-deployment-${SHA}.zip
          aws s3 cp backend/cfacts-snowflake-deployment-${SHA}.zip s3://$LAMBDA_BUCKET/cfacts-snowflake-deployment-latest.zip

          # CFACTS S3 Lambda
          aws s3 cp backend/cfacts-s3-deployment-${SHA}.zip s3://$LAMBDA_BUCKET/cfacts-s3-deployment-${SHA}.zip
          aws s3 cp backend/cfacts-s3-deployment-${SHA}.zip s3://$LAMBDA_BUCKET/cfacts-s3-deployment-latest.zip

          echo "All Lambda deployment packages uploaded successfully"

      - name: Lambda - Update Function Code
        run: |
          set -e
          ENV_LOWER=$(echo "${{ inputs.environment }}" | tr '[:upper:]' '[:lower:]')
          LAMBDA_BUCKET="ztmf-lambda-deployments-${ENV_LOWER}"
          SHA="${{ steps.revParse.outputs.shaShort }}"

          # Update each Lambda function if it exists
          for FUNC_PAIR in \
            "ztmf-data-sync-${ENV_LOWER}:lambda-deployment-${SHA}.zip" \
            "ztmf-cfacts-snowflake-sync-${ENV_LOWER}:cfacts-snowflake-deployment-${SHA}.zip" \
            "ztmf-cfacts-s3-sync-${ENV_LOWER}:cfacts-s3-deployment-${SHA}.zip"; do

            LAMBDA_FUNCTION="${FUNC_PAIR%%:*}"
            S3_KEY="${FUNC_PAIR#*:}"

            echo "Checking Lambda function: $LAMBDA_FUNCTION"
            if aws lambda get-function --function-name $LAMBDA_FUNCTION >/dev/null 2>&1; then
              echo "Updating: $LAMBDA_FUNCTION with $S3_KEY"
              aws lambda update-function-code \
                --function-name $LAMBDA_FUNCTION \
                --s3-bucket $LAMBDA_BUCKET \
                --s3-key $S3_KEY
              echo "Updated successfully: $LAMBDA_FUNCTION"
            else
              echo "Function doesn't exist yet: $LAMBDA_FUNCTION (will be created by infrastructure workflow)"
            fi
          done
        
      - name: AWS - SSM Put Parameter
        run: aws ssm put-parameter --name ${{ secrets.PARAMETER_NAME }} --value ${{ steps.revParse.outputs.shaShort }} --overwrite

      # Deployment of the latest image will happen with terraform apply during infrastructure deploy
